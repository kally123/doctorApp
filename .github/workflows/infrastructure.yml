name: Infrastructure Validation

on:
  push:
    branches: [main, develop]
    paths:
      - 'k8s/**'
      - 'docker-compose.yaml'
      - '.github/workflows/infrastructure.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'k8s/**'
      - 'docker-compose.yaml'

jobs:
  validate-kubernetes:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin/

      - name: Validate manifests
        run: |
          kubeval --strict --ignore-missing-schemas k8s/*.yaml
          kubeval --strict --ignore-missing-schemas k8s/services/*.yaml
          kubeval --strict --ignore-missing-schemas k8s/infrastructure/*.yaml

      - name: Install kube-score
        run: |
          wget https://github.com/zegl/kube-score/releases/download/v1.17.0/kube-score_1.17.0_linux_amd64.tar.gz
          tar xf kube-score_1.17.0_linux_amd64.tar.gz
          sudo mv kube-score /usr/local/bin/

      - name: Score manifests
        run: |
          kube-score score k8s/services/*.yaml || true
        continue-on-error: true

  validate-docker-compose:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yaml
        run: docker compose config

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'k8s/'
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Run checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: k8s/
          soft_fail: true
          framework: kubernetes
